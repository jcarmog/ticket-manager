<p-menu #menu [model]="items" [popup]="true" appendTo="body"></p-menu>
<div class="bg-white rounded-xl border border-slate-200 shadow-sm p-6">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
        <div class="flex flex-col md:flex-row items-start md:items-center gap-4 w-full md:w-auto">
            <h2 class="text-xl font-bold text-slate-800">{{ 'TICKET_LIST.TITLE' | translate }}</h2>
            <p-dropdown *ngIf="shouldShowTeamFilter()" [options]="teams()" [(ngModel)]="selectedTeamId"
                optionLabel="name" optionValue="id" placeholder="{{ 'TICKET_LIST.FILTER_TEAM' | translate }}"
                (onChange)="loadTickets()" class="w-full md:w-auto md:ml-4" styleClass="w-full md:w-48"></p-dropdown>
            <p-selectButton [options]="filterOptions" [(ngModel)]="currentFilter" optionLabel="label"
                optionValue="value" (onChange)="loadTickets()" styleClass="w-full md:w-auto">
            </p-selectButton>
        </div>
        <p-button [label]="'TICKET_LIST.NEW_TICKET' | translate" icon="pi pi-plus" routerLink="/tickets/new"
            styleClass="w-full md:w-auto"></p-button>
    </div>

    <p-accordion [multiple]="true" [(activeIndex)]="activeIndices">
        <p-accordionTab *ngFor="let status of ticketStatuses"
            [header]="('TICKET.STATUS_LABEL.' + status | translate) + ' (' + totalRecordsByStatus[status] + ')'">
            <p-table [value]="getTicketsByStatus(status)" [tableStyle]="{ 'min-width': '60rem' }" [paginator]="true"
                [rows]="10" [lazy]="true" (onLazyLoad)="loadTickets($event, status)"
                [totalRecords]="totalRecordsByStatus[status]" [loading]="loadingByStatus[status]"
                [rowsPerPageOptions]="[5, 10, 20]">
                <ng-template pTemplate="header">
                    <tr>
                        <th>{{ 'TICKET.NUMBER' | translate }}</th>
                        <th>{{ 'TICKET.TITLE' | translate }}</th>
                        <th>{{ 'TICKET.PRIORITY' | translate }}</th>
                        <th>{{ 'TICKET.ASSIGNED_TO' | translate }}</th>
                        <th>{{ 'TICKET.CREATED_BY' | translate }}</th>
                        <th>{{ 'TICKET_LIST.TEAM' | translate }}</th>
                        <th>{{ 'TICKET_LIST.CREATED_AT' | translate }}</th>
                        <th>{{ 'TICKET_LIST.ACTIONS' | translate }}</th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-ticket>
                    <tr>
                        <td>{{ ticket.ticketNumber }}</td>
                        <td>{{ ticket.title }}</td>
                        <td>
                            <p-tag [value]="'TICKET.PRIORITY_LABEL.' + ticket.priority | translate"
                                [severity]="getPrioritySeverity(ticket.priority)"></p-tag>
                        </td>
                        <td>
                            <div *ngIf="ticket.assignedTo" class="flex items-center gap-2">
                                <p-avatar [image]="ticket.assignedTo.avatarUrl"
                                    [label]="!ticket.assignedTo.avatarUrl ? ticket.assignedTo.name.charAt(0) : undefined"
                                    shape="circle" [style]="{'background-color': '#e0e7ff', 'color': '#4338ca'}">
                                </p-avatar>
                                <span>{{ ticket.assignedTo.name }}</span>
                            </div>
                            <span *ngIf="!ticket.assignedTo" class="text-slate-400 italic">{{ 'TICKET_LIST.UNASSIGNED' |
                                translate }}</span>
                        </td>
                        <td>
                            <div *ngIf="ticket.createdBy" class="flex items-center gap-2">
                                <p-avatar [image]="ticket.createdBy.avatarUrl"
                                    [label]="!ticket.createdBy.avatarUrl ? ticket.createdBy.name.charAt(0) : undefined"
                                    shape="circle" [style]="{'background-color': '#e0e7ff', 'color': '#4338ca'}">
                                </p-avatar>
                                <span>{{ ticket.createdBy.name }}</span>
                            </div>
                        </td>
                        <td>
                            <span *ngIf="ticket.assignedTeam">{{ ticket.assignedTeam.name }}</span>
                            <span *ngIf="!ticket.assignedTeam" class="text-slate-400 italic">-</span>
                        </td>
                        <td>{{ ticket.createdAt | date:'mediumDate' }}</td>
                        <td>
                            <div class="flex justify-center">
                                <p-button icon="pi pi-ellipsis-v" [rounded]="true" [text]="true" severity="secondary"
                                    (click)="showMenu(menu, $event, ticket)"></p-button>
                            </div>
                        </td>
                    </tr>
                </ng-template>
                <ng-template pTemplate="emptymessage">
                    <tr>
                        <td colspan="8" class="text-center p-4 text-slate-500">{{ 'TICKET_LIST.NO_TICKETS_STATUS' |
                            translate }}</td>
                    </tr>
                </ng-template>
            </p-table>
        </p-accordionTab>
    </p-accordion>
</div>

<p-dialog [header]="'DIALOG.FORWARD_TITLE' | translate" [(visible)]="forwardDialogVisible" [modal]="true"
    [breakpoints]="{'960px': '75vw', '640px': '90vw'}" [style]="{width: '50vw'}"
    [contentStyle]="{'overflow': 'visible'}">
    <div class="flex flex-col gap-4" style="min-height: 200px;">
        <label for="team" class="font-semibold">{{ 'DIALOG.SELECT_TEAM' | translate }}</label>
        <p-dropdown [options]="teams()" [(ngModel)]="selectedTeamId" optionLabel="name" optionValue="id"
            [placeholder]="'DIALOG.SELECT_TEAM' | translate" styleClass="w-full" appendTo="body">
        </p-dropdown>
    </div>
    <ng-template pTemplate="footer">
        <p-button [label]="'ACTIONS.CANCEL' | translate" (click)="forwardDialogVisible = false" [outlined]="true"
            severity="secondary"></p-button>
        <p-button [label]="'ACTIONS.FORWARD' | translate" (click)="forwardTicket()"
            [disabled]="!selectedTeamId"></p-button>
    </ng-template>
</p-dialog>

<p-dialog [header]="'DIALOG.START_TITLE' | translate" [(visible)]="startDialogVisible" [modal]="true"
    [style]="{width: '30vw'}">
    <div class="flex flex-col gap-4">
        <p class="text-slate-600 mb-2">{{ 'DIALOG.START_MSG' | translate }}</p>

        <div class="flex flex-col gap-2">
            <label for="estimatedTime" class="font-semibold">{{ 'DIALOG.ESTIMATED_TIME' | translate }}</label>
            <input pInputText id="estimatedTime" [(ngModel)]="estimation.time" placeholder="e.g. 4h" />
        </div>

        <div class="flex flex-col gap-2">
            <label for="estimatedFinishDate" class="font-semibold">{{ 'DIALOG.ESTIMATED_DATE' | translate }}</label>
            <p-calendar [(ngModel)]="estimation.date" dateFormat="dd/mm/yy" [minDate]="minDate" [showIcon]="true"
                appendTo="body"></p-calendar>
        </div>
    </div>
    <ng-template pTemplate="footer">
        <p-button [label]="'ACTIONS.CANCEL' | translate" (click)="startDialogVisible = false" [outlined]="true"
            severity="secondary"></p-button>
        <p-button [label]="'ACTIONS.START' | translate" (click)="confirmStartTicket()"
            [disabled]="!estimation.time || !estimation.date"></p-button>
    </ng-template>
</p-dialog>

<p-dialog [header]="'DIALOG.PAUSE_TITLE' | translate" [(visible)]="pauseDialogVisible" [modal]="true"
    [style]="{width: '30vw'}">
    <div class="flex flex-col gap-4">
        <p class="text-slate-600 mb-2">{{ 'DIALOG.PAUSE_MSG' | translate }}</p>
        <div class="flex flex-col gap-2">
            <label for="pauseReason" class="font-semibold">{{ 'DIALOG.REASON' | translate }}</label>
            <textarea pInputTextarea id="pauseReason" [(ngModel)]="pauseReason" rows="3" class="w-full"></textarea>
        </div>
    </div>
    <ng-template pTemplate="footer">
        <p-button [label]="'ACTIONS.CANCEL' | translate" (click)="pauseDialogVisible = false" [outlined]="true"
            severity="secondary"></p-button>
        <p-button [label]="'ACTIONS.PAUSE' | translate" (click)="confirmPauseTicket()"
            [disabled]="!pauseReason"></p-button>
    </ng-template>
</p-dialog>